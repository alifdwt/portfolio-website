name: Deploy Portfolio (Production)

on:
  push:
    branches: [main]
  workflow_run:
    workflows:
      - CI – Build Portfolio Image (Production)
    types:
      - completed

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  IMAGE_TAG: latest

jobs:
  deploy:
    name: Deploy to Home Server (Production)
    runs-on: [self-hosted, linux, homelab, deploy]

    permissions:
      contents: read
      packages: read

    steps:
      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" \
            | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Prepare project directory
        run: |
          mkdir -p ~/projects/portfolio-website
          cd ~/projects/portfolio-website

      - name: Pull latest production image
        run: |
          docker pull $REGISTRY/$IMAGE_NAME:$IMAGE_TAG

      - name: Restart production container
        run: |
          cd ~/projects/portfolio-website
          docker compose up -d portfolio-main

      - name: Cleanup unused images
        run: docker image prune -f

      - name: Health check
        run: |
          echo "⏳ Waiting for app to be ready..."
          sleep 10
          curl -f http://localhost:3005 || (
            echo "❌ Health check failed"
            docker logs portfolio-main
            exit 1
          )
